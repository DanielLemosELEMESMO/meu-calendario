# Plano de Versao: v0.3.0 - Sessao, Conclusao Persistida e CRUD de Eventos

Este documento define o escopo da v0.3.0 do MeuCalendario. O foco e concluir o fluxo funcional para piloto: logout, estado de conclusao persistido, criacao e edicao/exclusao de eventos no Google Calendar.

---

## 1. Objetivos da Versao

- Permitir logout seguro (limpeza de sessao via cookie).
- Persistir status "concluido" no banco (nao depender de localStorage).
- Criar novos eventos no Google Calendar.
- Editar e excluir eventos existentes no Google Calendar.

---

## 2. Escopo Detalhado

### 2.1. Backend (`server/`)

**2.1.1. Logout**
- **Endpoints:** `POST /auth/logout`
- **Comportamento:** limpar cookie `mc_session` e retornar `{ ok: true }`.

**2.1.2. Persistencia de "concluido"**
- **Novas tabelas:**
  - `event_status` com `user_id`, `event_id`, `completed`, `updated_at`.
- **Endpoints:**
  - `GET /api/event-status?start=...&end=...` (opcional, pode ser embutido em `/api/events`)
  - `POST /api/event-status` para marcar/desmarcar.
- **Regras:**
  - Status e por usuario.
  - Eventos inexistentes no Google nao devem quebrar o fluxo (ignorar).

**2.1.3. Criacao de eventos**
- **Endpoint:** `POST /api/events`
- **Payload:** `{ title, description?, start, end, calendarId? }`
- **Comportamento:** criar evento no Google Calendar e retornar o evento mapeado ao modelo do frontend.

**2.1.4. Edicao e exclusao**
- **Endpoints:**
  - `PATCH /api/events/:id` (atualizar titulo, descricao, horario)
  - `DELETE /api/events/:id` (excluir)
- **Comportamento:** refletir alteracoes no Google Calendar.
 - **Status atual:** update implementado, delete pendente.

### 2.2. Frontend (`client/`)

**2.2.1. Logout**
- Botao de logout no header, chamando `POST /auth/logout`.

**2.2.2. Persistencia de "concluido"**
- Remover uso de `localStorage` para concluido.
- Ao marcar evento, chamar `POST /api/event-status`.
- Ao carregar eventos, usar status vindo da API.

**2.2.3. Criacao de eventos**
- UX baseada em interacao direta no calendario (foco e semana):
  - **Gatilho:** clique em um horario/slot vazio do dia.
  - **Feedback imediato:** cria um "esqueleto" do evento no grid.
  - **Ajuste de duracao:** arrastar as extremidades superior/inferior do box para ajustar horario.
  - **Mover draft:** arrastar o bloco em criacao para ajustar horario e dia.
  - **Formulario lateral:** painel ao lado com campos (titulo, descricao, inicio, fim) e botao salvar.
  - **Salvar:** envia para `POST /api/events` e atualiza a lista local.
  - **Cancelar:** `Esc` ou clique fora do draft/painel.
  - **Referencia de UI:** comportamento semelhante ao popup de detalhes no modo semana.

**2.2.4. Edicao e exclusao**
- Acoes no card/popover para editar ou excluir.
- Chamar `PATCH`/`DELETE` e atualizar UI.
 - **Status atual:** ainda nao implementado no frontend.

**2.2.5. Arrastar e redimensionar eventos**
- **Arrastar:** eventos podem ser movidos entre horarios e dias (Foco/Semana).
- **Resize:** alcas aparecem no hover e permitem ajustar inicio/fim.
- **Feedback:** drag layer flutuante mostra titulo + horario atual.
- **Cancelar drag:** `Esc` cancela a operacao.

---

## 3. Banco de Dados (Supabase)

```sql
create table if not exists public.event_status (
  user_id uuid not null references public.users(id) on delete cascade,
  event_id text not null,
  completed boolean not null default false,
  updated_at timestamptz not null default now(),
  primary key (user_id, event_id)
);

create trigger trg_event_status_updated
before update on public.event_status
for each row execute function public.set_updated_at();
```

---

## 4. Consideracoes

- A criacao/edicao/exclusao depende de escopos ja existentes (`calendar.events`).
- O status "concluido" e uma camada local do app, nao existe no Google Calendar.
- Em producao, avaliar criptografar refresh_token.

---

## 5. Status Atual (Resumo)

- **Backend pronto:** logout, status de conclusao, criar evento, atualizar evento.
- **Frontend pronto:** login funcional, criacao de eventos com draft, drag entre dias, resize com alcas, formulario lateral e cancelamento com `Esc`.
- **Pendente:** exclusao de eventos e UI de edicao completa no frontend.
